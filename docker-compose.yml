# ===========================================
# TMS - Transport Management System
# Production Docker Compose
# ===========================================
# 
# Dit bestand wordt automatisch geconfigureerd
# door install.sh. Handmatig aanpassen kan ook.
#
# Services:
# - db: PostgreSQL database
# - redis: Cache server  
# - backend: Django API
# - frontend: React app
# - npm: Nginx Proxy Manager (UI op poort 81)
# - portainer: Container beheer (UI op poort 9443)
# ===========================================

services:
  # =========================================
  # PostgreSQL Database
  # =========================================
  db:
    image: postgres:16-alpine
    container_name: tms_db
    restart: always
    environment:
      POSTGRES_DB: ${DB_NAME:-tms_db}
      POSTGRES_USER: ${DB_USER:-tms_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?Database wachtwoord is verplicht}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-tms_user} -d ${DB_NAME:-tms_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tms_internal

  # =========================================
  # Redis Cache
  # =========================================
  redis:
    image: redis:7-alpine
    container_name: tms_redis
    restart: always
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tms_internal

  # =========================================
  # Django Backend API
  # =========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: tms_backend
    restart: always
    dns:
      - 8.8.8.8
      - 8.8.4.4
    extra_hosts:
      - "smtp.office365.com:40.99.149.98"
    environment:
      - DJANGO_SETTINGS_MODULE=tms.settings.production
      - SECRET_KEY=${SECRET_KEY:?Secret key is verplicht}
      - DB_NAME=${DB_NAME:-tms_db}
      - DB_USER=${DB_USER:-tms_user}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=5432
      - REDIS_URL=redis://redis:6379/1
      - ALLOWED_HOSTS=${DOMAIN_NAME:-localhost},localhost,backend
      - CORS_ALLOWED_ORIGINS=https://${DOMAIN_NAME:-localhost},http://localhost
      - SECURE_SSL_REDIRECT=false
      - SESSION_COOKIE_SECURE=true
      - CSRF_COOKIE_SECURE=true
    volumes:
      - static_files:/app/staticfiles
      - media_files:/app/media
      - logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tms_internal
    expose:
      - "8000"

  # =========================================
  # React Frontend
  # =========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=/api
    container_name: tms_frontend
    restart: always
    networks:
      - tms_internal
    expose:
      - "80"

  # =========================================
  # Nginx Proxy Manager
  # UI: http://server-ip:81
  # Beheert SSL en reverse proxy
  # =========================================
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: tms_npm
    restart: always
    ports:
      - '80:80'      # HTTP
      - '443:443'    # HTTPS
      - '81:81'      # Admin UI
    environment:
      - DB_SQLITE_FILE=/data/database.sqlite
      - DISABLE_IPV6=true
    volumes:
      - npm_data:/data
      - npm_letsencrypt:/etc/letsencrypt
    networks:
      - tms_internal
      - tms_external
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:81/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =========================================
  # Portainer - Container Management
  # UI: https://server-ip:9443
  # =========================================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: tms_portainer
    restart: always
    ports:
      - '9443:9443'  # HTTPS UI
      - '8000:8000'  # Edge agent (optioneel)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - tms_external

# =========================================
# Volumes
# =========================================
volumes:
  postgres_data:
    name: tms_postgres_data
  redis_data:
    name: tms_redis_data
  static_files:
    name: tms_static_files
  media_files:
    name: tms_media_files
  logs:
    name: tms_logs
  npm_data:
    name: tms_npm_data
  npm_letsencrypt:
    name: tms_npm_letsencrypt
  portainer_data:
    name: tms_portainer_data

# =========================================
# Networks
# =========================================
networks:
  tms_internal:
    name: tms_internal
    driver: bridge
    internal: true  # Geen externe toegang
  tms_external:
    name: tms_external
    driver: bridge
